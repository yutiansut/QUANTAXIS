# QUANTAXIS QABook PDFè‡ªåŠ¨ç¼–è¯‘ä¸å‘å¸ƒ
#
# åŠŸèƒ½è¯´æ˜:
# - å½“qabook/ç›®å½•æœ‰æ›´æ–°æ—¶è‡ªåŠ¨è§¦å‘
# - ä½¿ç”¨XeLaTeXç¼–è¯‘ç”ŸæˆPDF
# - è‡ªåŠ¨å‘å¸ƒåˆ°GitHub Releases
#
# ä½œè€…: @yutiansut @quantaxis
# æ›´æ–°æ—¥æœŸ: 2025-10-25

name: ç¼–è¯‘QABook PDF

on:
  push:
    branches:
      - master
    paths:
      - 'qabook/**'
      - '.github/workflows/qabook-build.yml'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-pdf:
    name: ç¼–è¯‘LaTeXä¸ºPDF
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: å®‰è£…TeX Live
        run: |
          echo "ğŸ“¦ å®‰è£…TeX Live..."
          sudo apt-get update
          sudo apt-get install -y \
            texlive-xetex \
            texlive-latex-extra \
            texlive-lang-chinese \
            texlive-fonts-recommended \
            texlive-science \
            fonts-wqy-microhei \
            fonts-wqy-zenhei

      - name: éªŒè¯XeLaTeXå®‰è£…
        run: |
          echo "âœ… éªŒè¯XeLaTeX..."
          xelatex --version

      - name: ç¼–è¯‘PDF (ç¬¬ä¸€æ¬¡)
        working-directory: qabook
        run: |
          echo "ğŸ“„ ç¬¬ä¸€æ¬¡ç¼–è¯‘..."
          xelatex -interaction=nonstopmode quantaxis.tex || {
            echo "âŒ ç¼–è¯‘å¤±è´¥ï¼ŒæŸ¥çœ‹æ—¥å¿—ï¼š"
            tail -50 quantaxis.log
            exit 1
          }

      - name: ç¼–è¯‘PDF (ç¬¬äºŒæ¬¡)
        working-directory: qabook
        run: |
          echo "ğŸ“„ ç¬¬äºŒæ¬¡ç¼–è¯‘..."
          xelatex -interaction=nonstopmode quantaxis.tex

      - name: ç¼–è¯‘PDF (ç¬¬ä¸‰æ¬¡)
        working-directory: qabook
        run: |
          echo "ğŸ“„ ç¬¬ä¸‰æ¬¡ç¼–è¯‘..."
          xelatex -interaction=nonstopmode quantaxis.tex

      - name: æ£€æŸ¥PDFç”Ÿæˆ
        working-directory: qabook
        run: |
          if [ -f "quantaxis.pdf" ]; then
            FILE_SIZE=$(du -h quantaxis.pdf | cut -f1)
            echo "âœ… PDFç”ŸæˆæˆåŠŸï¼"
            echo "ğŸ“Š æ–‡ä»¶å¤§å°: ${FILE_SIZE}"
            ls -lh quantaxis.pdf
          else
            echo "âŒ PDFç”Ÿæˆå¤±è´¥ï¼"
            exit 1
          fi

      - name: ç”Ÿæˆç‰ˆæœ¬æ ‡ç­¾
        id: version
        run: |
          # ä½¿ç”¨æ—¥æœŸä½œä¸ºç‰ˆæœ¬å·
          VERSION="qabook-$(date +'%Y%m%d-%H%M%S')"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "ğŸ“Œ ç‰ˆæœ¬: ${VERSION}"

      - name: åˆ›å»ºRelease
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.version.outputs.version }}
          release_name: QABook PDF - ${{ steps.version.outputs.version }}
          body: |
            # QUANTAXIS QABook PDF

            **è‡ªåŠ¨ç¼–è¯‘ç”Ÿæˆ**

            - ğŸ“… ç¼–è¯‘æ—¶é—´: ${{ github.event.head_commit.timestamp }}
            - ğŸ”– æäº¤: ${{ github.sha }}
            - ğŸ‘¤ ä½œè€…: ${{ github.actor }}
            - ğŸ’¬ æäº¤ä¿¡æ¯: ${{ github.event.head_commit.message }}

            ---

            ## ğŸ“¥ ä¸‹è½½

            ç‚¹å‡»ä¸‹æ–¹çš„ `quantaxis.pdf` ä¸‹è½½å®Œæ•´æ–‡æ¡£ã€‚

            ## ğŸ“š å†…å®¹

            QABookåŒ…å«QUANTAXISçš„å®Œæ•´æŠ€æœ¯æ–‡æ¡£ï¼Œæ¶µç›–ï¼š
            - é‡åŒ–äº¤æ˜“ç†è®ºåŸºç¡€
            - æ•°å­¦å’Œç»Ÿè®¡å­¦çŸ¥è¯†
            - ç°ä»£èµ„äº§ç®¡ç†ç†è®º
            - ç»„åˆä¼˜åŒ–ç­–ç•¥
            - æœŸæƒå®šä»·ç†è®º

            ---

            **è‡ªåŠ¨ç”Ÿæˆ by GitHub Actions**
          draft: false
          prerelease: false

      - name: ä¸Šä¼ PDFåˆ°Release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./qabook/quantaxis.pdf
          asset_name: quantaxis.pdf
          asset_content_type: application/pdf

      - name: æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        if: always()
        working-directory: qabook
        run: |
          echo "ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
          rm -f *.aux *.log *.out *.toc *.gz *.fdb_latexmk *.fls *.synctex.gz || true

      - name: å®Œæˆ
        run: |
          echo "âœ… QABook PDFç¼–è¯‘å®Œæˆï¼"
          echo "ğŸ“¦ å·²å‘å¸ƒåˆ°Release: ${{ steps.version.outputs.version }}"
